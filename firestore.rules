rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== HELPER FUNCTIONS ====================

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // ==================== USERS COLLECTION ====================

    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && request.auth.uid == userId;
      allow update: if isAdmin();
      allow update: if isSignedIn() &&
        request.auth.uid != userId &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['coins', 'totalCoinsEarned', 'referralCount']) &&
        request.resource.data.coins >= resource.data.coins &&
        request.resource.data.totalCoinsEarned >= resource.data.totalCoinsEarned &&
        request.resource.data.referralCount == resource.data.referralCount + 1;
      allow delete: if isAdmin();

      match /exchanges/{exchangeId} {
        allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin());
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow update, delete: if isAdmin();
      }
    }

    // ==================== TASKS ====================

    match /tasks/{taskId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ==================== TASK COMPLETIONS ====================

    match /task_completions/{completionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.uid;
      allow update, delete: if false;
    }

    // ==================== SETTINGS ====================

    match /settings/{document} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ==================== PROMO CODES ====================

    match /promo_codes/{code} {
      allow read: if isSignedIn();
      allow create: if false;
      allow update: if isSignedIn() &&
        resource.data.used == false &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['used', 'used_by', 'used_at']) &&
        request.resource.data.used == true &&
        request.resource.data.used_by == request.auth.uid;
      allow delete: if false;
    }

    // ==================== BOT CONFIG ====================

    match /bot_config/{document} {
      allow read: if isSignedIn();
      allow write: if false;
    }

    match /bot_users/{document} {
      allow read, write: if false;
    }

    // ==================== ANNOUNCEMENTS ====================

    match /announcements/{announcementId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ==================== UC ORDERS ====================

    match /uc_orders/{orderId} {
      allow read: if isSignedIn() && (resource.data.uid == request.auth.uid || isAdmin());
      allow create: if isSignedIn() && request.resource.data.uid == request.auth.uid;
      allow update, delete: if isAdmin();
    }
  }
}
